#!/bin/bash
set -euo pipefail

# Files and trait names
declare -A FILES=(
  ["Asthma"]="Asthma_Bothsex_eur_inv_var_meta_GBMI_052021_nbbkgt1.txt.gz"
  ["COPD"]="COPD_Bothsex_eur_inv_var_meta_GBMI_052021_nbbkgt1.txt.gz"
  ["HF"]="HF_Bothsex_eur_inv_var_meta_GBMI_052021_nbbkgt1.txt.gz"
  ["Stroke"]="Stroke_Bothsex_eur_inv_var_meta_GBMI_052021_nbbkgt1.txt.gz"
)

OUTDIR="."
LOGDIR="logs"
mkdir -p "$LOGDIR"

for TRAIT in "${!FILES[@]}"; do
  INFILE="${FILES[$TRAIT]}"
  OUTFILE="GBMI_${TRAIT}.GSEM.tsv"
  GZOUT="${OUTFILE}.gz"

  echo "============================================"
  echo "▶ Processing GBMI_${TRAIT}"
  echo "  Input : $INFILE"
  echo "  Output: $GZOUT"
  echo "============================================"

  # ---------- Conversion ----------
  zcat "$INFILE" | \
  awk 'BEGIN{FS=OFS="\t"}
    NR==1 {
      print "SNP","A1","A2","BETA","SE","P","N";
      next
    }
    {
      snp=$5;
      a1=$4;   # ALT
      a2=$3;   # REF
      beta=$7;
      se=$8;
      p=$9;
      n=$11 + $12;  # N_case + N_ctrl

      if (snp=="NA" || snp=="" || p<=0 || p>=1) next;

      print snp,a1,a2,beta,se,p,n
    }' > "$OUTFILE"

  # ---------- Sanity checks ----------
  echo "• Sanity checks for GBMI_${TRAIT}"

  echo -n "  Header: "
  head -n 1 "$OUTFILE"

  echo -n "  Columns (should be 7): "
  awk 'NR==2{print NF}' "$OUTFILE"

  echo -n "  Rows: "
  wc -l "$OUTFILE"

  echo -n "  Bad P-values (<=0 or >=1): "
  awk 'NR>1 && ($6<=0 || $6>=1){c++} END{print c+0}' "$OUTFILE"

  echo -n "  Missing SNP IDs: "
  awk 'NR>1 && ($1=="NA" || $1==""){c++} END{print c+0}' "$OUTFILE"

  # ---------- Compress ----------
  gzip -f "$OUTFILE"

  echo "✔ GBMI_${TRAIT} done"
done

echo "============================================"
echo "✅ All GBMI traits converted to GSEM format"
